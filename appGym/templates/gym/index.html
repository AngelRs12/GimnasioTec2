{% extends 'gym/base.html' %} {% load static %} {% block title %}Inicio |
Gimnasio{% endblock %} {% block content %}
<style>
  .carousel-inner img {
    width: 100%;
    height: 70vh; /* Ajusta la altura a tu gusto */
    object-fit: cover; /* Mantiene proporciones y recorta los bordes si es necesario */
  }
  .noticia-img {
    width: 100%;
    max-height: 300px; /* l√≠mite visual */
    object-fit: contain; /* üîë imagen completa */
  }
</style>
<!-- ====== Contenido principal ====== -->
<div class="content">
  <!-- Carrusel de im√°genes -->
  <div
    id="carouselGimnasio"
    class="carousel slide mb-5"
    data-bs-ride="carousel"
  >
    <!-- Indicadores -->
    <div class="carousel-indicators">
      <button
        type="button"
        data-bs-target="#carouselGimnasio"
        data-bs-slide-to="0"
        class="active"
        aria-current="true"
        aria-label="Slide 1"
      ></button>
      <button
        type="button"
        data-bs-target="#carouselGimnasio"
        data-bs-slide-to="1"
        aria-label="Slide 2"
      ></button>
      <button
        type="button"
        data-bs-target="#carouselGimnasio"
        data-bs-slide-to="2"
        aria-label="Slide 3"
      ></button>
    </div>
    <!-- Im√°genes del carrusel -->
    <div class="carousel-inner rounded shadow">
      <div class="carousel-item active">
        <img
          src="{% static 'gym/images/carrusel1.jpeg' %}"
          class="d-block w-100"
          alt="Instalaciones del gimnasio"
        />
        <div
          class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded"
        >
          <h5>Bienvenido al LiebreGym</h5>
          <p>Entrena, mejora y supera tus l√≠mites cada d√≠a.</p>
        </div>
      </div>
      <div class="carousel-item">
        <img
          src="{% static 'gym/images/carrusel2.jpeg' %}"
          class="d-block w-100"
          alt="Clases grupales"
        />
        <div
          class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded"
        >
          <h5>Zona de pesas y cardio</h5>
          <p>Equipos modernos y asesor√≠a profesional a tu disposici√≥n.</p>
        </div>
      </div>
      <div class="carousel-item">
        <img
          src="{% static 'gym/images/carrusel3.jpeg' %}"
          class="d-block w-100"
          alt="Zona de pesas"
        />
        <div
          class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded"
        >
          <h5>Actividades</h5>
          <p>Participa en clases dirigidas y entrenamientos grupales.</p>
        </div>
      </div>
    </div>
    <!-- Controles -->
    <button
      class="carousel-control-prev"
      type="button"
      data-bs-target="#carouselGimnasio"
      data-bs-slide="prev"
    >
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Anterior</span>
    </button>
    <button
      class="carousel-control-next"
      type="button"
      data-bs-target="#carouselGimnasio"
      data-bs-slide="next"
    >
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Siguiente</span>
    </button>
  </div>
</div>
<!-- ====== Secci√≥n de Noticias ====== -->

<div class="container mb-5">
  <h2 class="fw-bold text-center mb-4">Noticias del Gimnasio</h2>
  {% if request.session.usuario_admin %}
  <div class="container mb-4">
    <div
      class="alert alert-warning d-flex justify-content-between align-items-center shadow-sm"
    >
      <div class="d-flex gap-2">
        <button
          class="btn btn-success btn-sm"
          data-bs-toggle="modal"
          data-bs-target="#modalAgregarNoticia"
        >
          Agregar noticia
        </button>
      </div>
    </div>
  </div>
  {% endif %}
  <div id="alertaGlobalNoticias"></div>
  <div id="contenedorNoticias"></div>
</div>

<div
  class="modal fade"
  id="modalAgregarNoticia"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Agregar noticia</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>

      <div class="modal-body">
        <div id="alertaAgregarNoticia"></div>
        <form id="formAgregarNoticia" enctype="multipart/form-data">
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label">T√≠tulo</label>
            <input type="text" name="titulo" class="form-control" required />
          </div>

          <div class="mb-3">
            <label class="form-label">Descripci√≥n</label>
            <textarea
              name="descripcion"
              class="form-control"
              rows="4"
              required
            ></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">Imagen</label>
            <input
              type="file"
              name="imagen"
              class="form-control"
              accept="image/*"
            />
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button class="btn btn-success" id="btnGuardarNoticia">Guardar</button>
      </div>
    </div>
  </div>
</div>
<div
  class="modal fade"
  id="modalEditarNoticia"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar noticia</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>

      <div class="modal-body">
        <div id="alertaEditarNoticia"></div>
        <form id="formEditarNoticia" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="id_noticia" id="edit_id_noticia" />

          <div class="mb-3">
            <label class="form-label">T√≠tulo</label>
            <input
              type="text"
              name="titulo"
              id="edit_titulo"
              class="form-control"
              required
            />
          </div>

          <div class="mb-3">
            <label class="form-label">Descripci√≥n</label>
            <textarea
              name="descripcion"
              id="edit_descripcion"
              class="form-control"
              rows="4"
              required
            ></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label">Imagen (opcional)</label>
            <input
              type="file"
              name="imagen"
              id="edit_imagen"
              class="form-control"
              accept="image/*"
            />

            <small class="text-muted">
              Si no seleccionas imagen, se conservar√° la actual.
            </small>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button class="btn btn-primary" id="btnActualizarNoticia">
          Guardar cambios
        </button>
      </div>
    </div>
  </div>
</div>

<script>
     const ES_ADMIN = {{ request.session.usuario_admin|yesno:"true,false" }};
      async function cargarNoticias() {
      try {
        const response = await fetch("{% url 'listar_noticias' %}");
        const data = await response.json();

        const contenedor = document.getElementById("contenedorNoticias");
        contenedor.innerHTML = "";

        if (!data.success || data.noticias.length === 0) {
          contenedor.innerHTML = `
            <p class="text-center text-muted">No hay noticias registradas.</p>
          `;
          return;
        }

  data.noticias.forEach(noticia => {
    contenedor.innerHTML += `
      <div class="card shadow-sm border-0 mb-4">
        <div class="row g-0">

          <!-- TEXTO -->
          <div class="col-md-7">
            <div class="card-body d-flex flex-column h-100">
              <h5 class="card-title fw-bold">${noticia.titulo}</h5>

              <p class="text-muted mb-2">
                <small>Publicado el ${noticia.fecha_publicacion}</small>
              </p>

              <p class="card-text">
                ${noticia.descripcion}
              </p>
            </div>
          </div>

          <!-- IMAGEN -->
          <div class="col-md-5 d-flex align-items-center justify-content-center p-2">
            ${noticia.imagen ? `
              <img
                src="/media/${noticia.imagen}"
                class="img-fluid noticia-img"
                alt="Imagen noticia"
              />` : ""}
          </div>

        </div>

        ${ES_ADMIN ? `
        <div class="card-footer bg-light d-flex justify-content-end gap-2">
          <button
            class="btn btn-outline-primary btn-sm"
            onclick="editarNoticia(${noticia.id_noticia})"
          >
            Editar
          </button>
          <button
            class="btn btn-outline-danger btn-sm"
            onclick="eliminarNoticia(${noticia.id_noticia})"
          >
            Eliminar
          </button>
        </div>` : ""}
      </div>
    `;
  });


      } catch (error) {
        console.error("Error al cargar noticias:", error);
      }
    }

    // üöÄ Cargar al iniciar
    document.addEventListener("DOMContentLoaded", cargarNoticias);
    const btnGuardarNoticia = document.getElementById("btnGuardarNoticia");

 btnGuardarNoticia.addEventListener("click", async () => {
  const form = document.getElementById("formAgregarNoticia");

  // üßº limpiar alertas previas
  document.getElementById("alertaAgregarNoticia").innerHTML = "";

  const titulo = form.titulo.value.trim();
  const descripcion = form.descripcion.value.trim();

  // ‚ùå VALIDACIONES
  if (!tieneAlfanumerico(titulo)) {
    mostrarAlertaModalAgregar(
      "El t√≠tulo debe contener al menos un car√°cter alfanum√©rico"
    );
    return;
  }

  if (!tieneAlfanumerico(descripcion)) {
    mostrarAlertaModalAgregar(
      "La descripci√≥n debe contener al menos un car√°cter alfanum√©rico"
    );
    return;
  }

  const formData = new FormData(form);

  try {
    const response = await fetch("{% url 'guardar_noticia' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
      },
      body: formData,
    });

    const data = await response.json();

    if (data.success) {
      // ‚úÖ cerrar modal
      const modal = bootstrap.Modal.getInstance(
        document.getElementById("modalAgregarNoticia")
      );
      modal.hide();

      // üßº reset form (incluye file)
      form.reset();

      // ‚úÖ alerta global
      mostrarAlertaGlobal("Noticia guardada correctamente ‚úÖ", "success");

      // üîÑ refrescar listado
      cargarNoticias();

    } else {
      mostrarAlertaModalAgregar(data.error || "Error al guardar la noticia");
    }

  } catch (error) {
    console.error(error);
    mostrarAlertaModalAgregar("Error inesperado en la petici√≥n");
  }
});

  function resetFileInput(inputId) {
    const oldInput = document.getElementById(inputId);
    if (!oldInput) return;

    const newInput = oldInput.cloneNode(true);
    oldInput.parentNode.replaceChild(newInput, oldInput);
  }

  async function editarNoticia(id) {
    try {
      const form = document.getElementById("formEditarNoticia");

      form.reset();
      resetFileInput("edit_imagen");

      // üßº LIMPIAR ALERTA DEL MODAL
      document.getElementById("alertaEditarNoticia").innerHTML = "";

      const resp = await fetch(`/noticias/${id}/`);
      const data = await resp.json();

      if (!data.success) {
        mostrarAlertaModalEditar(data.error || "Error al cargar noticia");
        return;
      }

      document.getElementById("edit_id_noticia").value = data.noticia.id;
      document.getElementById("edit_titulo").value = data.noticia.titulo;
      document.getElementById("edit_descripcion").value = data.noticia.descripcion;

      const modal = new bootstrap.Modal(
        document.getElementById("modalEditarNoticia")
      );
      modal.show();

    } catch (error) {
      console.error(error);
      mostrarAlertaModalEditar("Error inesperado al cargar la noticia");
    }
  }




  document
    .getElementById("btnActualizarNoticia")
    .addEventListener("click", async () => {

const form = document.getElementById("formEditarNoticia");

    const titulo = form.titulo.value.trim();
    const descripcion = form.descripcion.value.trim();

    // ‚ùå VALIDACI√ìN
    if (!tieneAlfanumerico(titulo)) {
      mostrarAlertaModalEditar(
        "El t√≠tulo debe contener al menos un car√°cter alfanum√©rico"
      );
      return;
    }

    if (!tieneAlfanumerico(descripcion)) {
      mostrarAlertaModalEditar(
        "La descripci√≥n debe contener al menos un car√°cter alfanum√©rico"
      );
      return;
    }

    const formData = new FormData(form);

      try {
        const resp = await fetch("{% url 'actualizar_noticia' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
          },
          body: formData,
        });

        const data = await resp.json();

   if (data.success) {
    // ‚ùå alert("Noticia actualizada ‚úÖ");

    const modal = bootstrap.Modal.getInstance(
      document.getElementById("modalEditarNoticia")
    );
    modal.hide();

    cargarNoticias();

    // ‚úÖ ALERTA GLOBAL
    mostrarAlertaGlobal("Noticia actualizada correctamente ‚úÖ", "success");

  } else {
    // ‚ùå alert(data.error);

    // üö® ALERTA DENTRO DEL MODAL
    mostrarAlertaModalEditar(data.error || "Error al actualizar la noticia");
  }


      } catch (error) {
        console.error(error);
  mostrarAlertaModalEditar(data.error || "Error al actualizar la noticia");
      }
    });


  function eliminarNoticia(id) {
    if (!confirm("¬øSeguro que deseas eliminar esta noticia?")) return;
    alert("Eliminar noticia ID: " + id);
  }
  function mostrarAlertaGlobal(mensaje, tipo = "success") {
    const contenedor = document.getElementById("alertaGlobalNoticias");

    contenedor.innerHTML = `
      <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;

    // Auto cerrar despu√©s de 4s
    setTimeout(() => {
      const alerta = contenedor.querySelector(".alert");
      if (alerta) alerta.classList.remove("show");
    }, 4000);
  }

  function mostrarAlertaModalEditar(mensaje, tipo = "danger") {
    const contenedor = document.getElementById("alertaEditarNoticia");

    contenedor.innerHTML = `
      <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
  }
  function mostrarAlertaModalAgregar(mensaje, tipo = "danger") {
  const contenedor = document.getElementById("alertaAgregarNoticia");

  contenedor.innerHTML = `
    <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
      ${mensaje}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `;
}

  function tieneAlfanumerico(texto) {
  return /[a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë]/.test(texto);
}

</script>

{% endblock %}
